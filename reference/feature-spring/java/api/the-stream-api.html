<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>The Stream API :: DEV Cheat Sheets</title>
    <link rel="canonical" href="https://p-marcin.github.io/dev-cheat-sheets/reference/java/api/the-stream-api.html">
    <meta name="generator" content="Antora 3.1.9">
<link rel="stylesheet" href="../../../../_/css/site.css">
<link rel="stylesheet" href="../../../../_/css/doc-extension.css">
<link rel="stylesheet" href="../../../../_/css/header-extension.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://p-marcin.github.io/dev-cheat-sheets">DEV Cheat Sheets</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search">
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Projects</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/p-marcin/dev-cheat-sheets" target="_blank">Repository</a>
            <a class="navbar-item" href="https://github.com/p-marcin/dev-cheat-sheets/issues" target="_blank">Issue Tracker</a>
            <hr class="navbar-divider">
            <a class="navbar-item" href="https://github.com/p-marcin/java-dev-vm" target="_blank">Java DEV VM</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="reference" data-version="feature-spring">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../../index.html">DEV Cheat Sheets</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">â˜• Java</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">API</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lambda-expression.html">Lambda Expression</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="the-stream-api.html">The Stream API</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Concepts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../concepts/microservices.html">Microservices</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../concepts/reactive-programming.html">Reactive Programming</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../spring-framework/index.html">â˜˜ï¸ Spring Framework</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../spring-framework/spring-web-client.html">Spring WebClient</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../spring-framework/spring-security.html">Spring Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../spring-framework/spring-authorization-server.html">Spring Authorization Server</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../spring-framework/spring-resource-server.html">Spring Resource Server</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../spring-framework/debug.html">Debugging techniques</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">DEV Cheat Sheets</a></li>
    <li>â˜• Java</li>
    <li>API</li>
    <li><a href="the-stream-api.html">The Stream API</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">feature-spring</button>
  <div class="version-menu">
    <a class="version" href="../../../java/api/the-stream-api.html">default</a>
    <a class="version is-current" href="the-stream-api.html">feature-spring</a>
  </div>
</div>
<div class="edit-this-page"><a href="https://github.com/p-marcin/dev-cheat-sheets/blob/feature/spring/docs/modules/java/pages/api/the-stream-api.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">The Stream API</h1>
<div class="sect1">
<h2 id="_mapfilterreduce_algorithm_implementation_in_jdk"><a class="anchor" href="#_mapfilterreduce_algorithm_implementation_in_jdk"></a>Map/Filter/Reduce algorithm implementation in JDK</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Steps of the <strong>Map/Filter/Reduce algorithm</strong>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Map</dt>
<dd>
<p><strong>Changes the type</strong> of the data, <strong>does not change the number</strong> of elements. The mapping step <strong>respects the order</strong> of your objects</p>
</dd>
<dt class="hdlist1">Filter</dt>
<dd>
<p><strong>Does not change the type</strong> of the data, <strong>changes the number</strong> of elements. You may end up with no data</p>
</dd>
<dt class="hdlist1">Reduce</dt>
<dd>
<p>Produces <strong>a result</strong></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If we want to create <strong>an efficient implementation</strong> of the Map/Filter/Reduce algorithm, it <strong>should not duplicate any data</strong>. It should work in the same way, performance wise, as the <strong>iterative pattern</strong>. Map/Filter/Reduce algorithm implemented by the Collection API would cause <strong>duplication of the data</strong> (storing the data in an intermediate structure)</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">The Stream API</dt>
<dd>
<p>Implementation of the Map/Filter/Reduce algorithm that <strong>does not duplicate any data</strong> and that <strong>does not create any load on the CPU or memory</strong></p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Stream by definition is <strong>an empty object</strong> - it does not carry any kind of data
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Every time you call a method on a Stream that returns another Stream, it is going to be <strong>a new Stream object</strong>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Difference between the Stream API and iterative approach is that in the Stream API we <strong>describe the computation and not how this computation should be conducted</strong>. This is none of my business, this is the business of the API</p>
</div>
<div class="paragraph">
<p>Reduce method triggers <strong>the computation of the elements</strong>, and those elements are going to be taken <strong>one-by-one, first mapped, then filtered and computed if they pass the filtering step</strong>. Using Streams is about <strong>creating pipelines of operations</strong>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Intermediate operation (Map/Filter)</dt>
<dd>
<p>Operation that creates a Stream (it does not do anything, it does not process any data)</p>
</dd>
<dt class="hdlist1">Terminal operation (Reduce)</dt>
<dd>
<p>Operation that produces a result (it will trigger the computation of the elements)</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you have a pattern using a Stream that <strong>does not end up with a Terminal operation</strong>, your pattern is not going to process any data. <strong>It will be useless code</strong>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
You are <strong>not allowed</strong> to process <strong>the same Stream twice</strong>. This is why it is completely useless to create intermittent variables to store the Streams. <strong>You should inline it</strong>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_stream_api"><a class="anchor" href="#_the_stream_api"></a>The Stream API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Stream API gives you <strong>4</strong> interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Stream.html" target="_blank" rel="noopener"><code>âšª <strong>Stream&lt;T&gt;</strong></code></a> - a sequence of elements supporting sequential and parallel aggregate operations</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 37.5%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Modifier and Type</th>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;R&gt; Stream&lt;R&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>map(Function&lt;? super T,? extends R&gt; mapper)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a stream consisting of the results of applying the given function to the elements of this stream.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IntStream</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mapToInt(ToIntFunction&lt;? super T&gt; mapper)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns an <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/IntStream.html" target="_blank" rel="noopener"><code>âšª IntStream</code></a> consisting of the results of applying the given function to the elements of this stream.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;R&gt; Stream&lt;R&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>flatMap(Function&lt;? super T,? extends Stream&lt;? extends R&gt;&gt; mapper)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a stream consisting of the results of replacing each element of this stream with the contents of a mapped stream produced by applying the provided mapping function to each element</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">long count = cities.stream() <i class="conum" data-value="1"></i><b>(1)</b>
    .flatMap(city -&gt; city.getPeople().stream()) <i class="conum" data-value="2"></i><b>(2)</b>
    .count(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>3 cities</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>With 3 people each</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns 9</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Stream&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>filter(Predicate&lt;? super T&gt; predicate)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a stream consisting of the elements of this stream that match the given predicate.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Optional&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reduce(BinaryOperator&lt;T&gt; accumulator)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Performs a reduction on the elements of this stream, using an associative accumulation function, and returns an <a href="https://docs.oracle.com/en/java/javase/21/docs//api/java.base/java/util/Optional.html" target="_blank" rel="noopener"><code>ğŸ”´ Optional&lt;T&gt;</code></a> describing the reduced value, if any. See <a href="#_reducing_data_to_compute_statistics">Reducing Data to compute Statistics</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>T</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reduce(T identity, BinaryOperator&lt;T&gt; accumulator)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Performs a reduction on the elements of this stream, using the provided identity value and an associative accumulation function, and returns the reduced value. See <a href="#_reducing_data_to_compute_statistics">Reducing Data to compute Statistics</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;R, A&gt; R</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>collect(Collector&lt;? super T,A,R&gt; collector)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Performs a mutable reduction operation on the elements of this stream using a <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Collector.html" target="_blank" rel="noopener"><code>âšª Collector&lt;T,A,R&gt;</code></a>. See <a href="#_the_collectors_api">The Collectors API</a> and <a href="#_collecting_data_from_streams_to_create_listssetsmaps">Collecting Data from Streams to create Lists/Sets/Maps</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Stream&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>distinct()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a stream consisting of the distinct elements (according to <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Object.html#equals(java.lang.Object)" target="_blank" rel="noopener"><code>Object#equals(Object)</code></a>) of this stream.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Stream&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sorted()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a stream consisting of the elements of this stream, sorted according to natural order.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>count()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns the count of elements in this stream.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Optional&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>min(Comparator&lt;? super T&gt; comparator)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns the minimum element of this stream according to the provided <code>âšª Comparator&lt;T&gt;</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Optional&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max(Comparator&lt;? super T&gt; comparator)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns the maximum element of this stream according to the provided <code>âšª Comparator&lt;T&gt;</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Object[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toArray()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns an array containing the elements of this stream.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;A&gt; A[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toArray(IntFunction&lt;A[]&gt; generator)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns an array containing the elements of this stream, using the provided generator function to allocate the returned array, as well as any additional arrays that might be required for a partitioned execution or for resizing. For example <code>toArray(String[]::new)</code> will return <code>String[]</code>.</p>
</div></div></td>
</tr>
</tbody>
</table>
</li>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/IntStream.html" target="_blank" rel="noopener"><code>âšª <strong>IntStream</strong></code></a> - <code>int</code> primitive specialization of <code>âšª Stream&lt;T&gt;</code></p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 37.5%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Modifier and Type</th>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OptionalInt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>min()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns an <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/OptionalInt.html" target="_blank" rel="noopener"><code>ğŸ”´ OptionalInt</code></a> describing the minimum element of this stream, or an empty optional if this stream is empty.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OptionalInt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns an <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/OptionalInt.html" target="_blank" rel="noopener"><code>ğŸ”´ OptionalInt</code></a> describing the maximum element of this stream, or an empty optional if this stream is empty.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OptionalDouble</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>average()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns an <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/OptionalDouble.html" target="_blank" rel="noopener"><code>ğŸ”´ OptionalDouble</code></a> describing the arithmetic mean of elements of this stream, or an empty optional if this stream is empty.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sum()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns the sum of elements in this stream.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IntSummaryStatistics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>summaryStatistics()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns an <a href="https://docs.oracle.com/en/java/javase/21/docs//api/java.base/java/util/IntSummaryStatistics.html" target="_blank" rel="noopener"><code>ğŸŸ¢ IntSummaryStatistics</code></a> describing various summary data about the elements of this stream.</p>
</div></div></td>
</tr>
</tbody>
</table>
</li>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/LongStream.html" target="_blank" rel="noopener"><code>âšª <strong>LongStream</strong></code></a> - <code>long</code> primitive specialization of <code>âšª Stream&lt;T&gt;</code>. It has similar methods to <code>âšª IntStream</code></p>
</li>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/DoubleStream.html" target="_blank" rel="noopener"><code>âšª <strong>DoubleStream</strong></code></a> - <code>double</code> primitive specialization of <code>âšª Stream&lt;T&gt;</code>. It has similar methods to <code>âšª IntStream</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_collectors_api"><a class="anchor" href="#_the_collectors_api"></a>The Collectors API</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Collectors.html" target="_blank" rel="noopener"><code>ğŸ”´ Collectors</code></a> - implementations of <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Collector.html" target="_blank" rel="noopener"><code>âšª Collector&lt;T,A,R&gt;</code></a> that implement various useful reduction operations, such as accumulating elements into collections, summarizing elements according to various criteria, etc.</p>
</div>
<div class="paragraph">
<p>Type parameters of <code>âšª Collector&lt;T,A,R&gt;</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>T</code> - the type of input elements to the reduction operation</p>
</li>
<li>
<p><code>A</code> - the mutable accumulation type of the reduction operation (often hidden as an implementation detail)</p>
</li>
<li>
<p><code>R</code> - the result type of the reduction operation</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 37.5%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Modifier and Type</th>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static &lt;T&gt; Collector&lt;T,?,List&lt;T&gt;&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toList()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a <code>âšª Collector&lt;T,A,R&gt;</code> that accumulates the input elements into a new <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/List.html" target="_blank" rel="noopener"><code>âšª List&lt;T&gt;</code></a>, in encounter order.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static &lt;T&gt; Collector&lt;T,?,List&lt;T&gt;&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toUnmodifiableList()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a <code>âšª Collector&lt;T,A,R&gt;</code> that accumulates the input elements into an unmodifiable <code>âšª List&lt;T&gt;</code>, in encounter order.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static &lt;T&gt; Collector&lt;T,?,Set&lt;T&gt;&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toSet()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a <code>âšª Collector&lt;T,A,R&gt;</code> that accumulates the input elements into a new <code>âšª Set&lt;T&gt;</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static &lt;T&gt; Collector&lt;T,?,Set&lt;T&gt;&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toUnmodifiableSet()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a <code>âšª Collector&lt;T,A,R&gt;</code> that accumulates the input elements into an unmodifiable <code>âšª Set&lt;T&gt;</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static &lt;T, C extends Collection&lt;T&gt;&gt; Collector&lt;T,?,C&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toCollection(Supplier&lt;C&gt; collectionFactory)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a <code>âšª Collector&lt;T,A,R&gt;</code> that accumulates the input elements into a new <code>âšª Collection&lt;T&gt;</code>, in encounter order. For example <code>toCollection(MyCollection::new)</code> will return <code>ğŸŸ¢ MyCollection</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static Collector&lt;CharSequence,?,String&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>joining()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a <code>âšª Collector&lt;T,A,R&gt;</code> that concatenates the input elements into a <code>ğŸ”´ String</code>, in encounter order. The string won&#8217;t be delimited.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static Collector&lt;CharSequence,?,String&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>joining(CharSequence delimiter)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a <code>âšª Collector&lt;T,A,R&gt;</code> that concatenates the input elements, separated by the specified delimiter, in encounter order.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static Collector&lt;CharSequence,?,String&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>joining(CharSequence delimiter, CharSequence prefix, CharSequence suffix)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a <code>âšª Collector&lt;T,A,R&gt;</code> that concatenates the input elements, separated by the specified delimiter, with the specified prefix and suffix, in encounter order.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static &lt;T, K&gt; Collector&lt;T,?,Map&lt;K,List&lt;T&gt;&gt;&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupingBy(Function&lt;? super T,? extends K&gt; classifier)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a <code>âšª Collector&lt;T,A,R&gt;</code> implementing a "group by" operation on input elements of type <code>T</code>, grouping elements according to a classification function, and returning the results in a <code>âšª Map</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static &lt;T, K, A, D&gt; Collector&lt;T,?,Map&lt;K,D&gt;&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groupingBy(Function&lt;? super T,? extends K&gt; classifier, Collector&lt;? super T,A,D&gt; downstream)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a <code>âšª Collector&lt;T,A,R&gt;</code> implementing a cascaded "group by" operation on input elements of type <code>T</code>, grouping elements according to a classification function, and then performing a reduction operation on the values associated with a given key using the specified downstream <code>âšª Collector&lt;T,A,R&gt;</code>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static &lt;T&gt; Collector&lt;T,?,Long&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>counting()</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a <code>âšª Collector&lt;T,A,R&gt;</code> accepting elements of type <code>T</code> that counts the number of input elements.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>static &lt;T&gt; Collector&lt;T,?,Integer&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>summingInt(ToIntFunction&lt;? super T&gt; mapper)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Returns a <code>âšª Collector&lt;T,A,R&gt;</code> that produces the sum of an integer-valued function applied to the input elements. For example <code>summingInt(City::getPopulation)</code> will return population of all cities.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_building_a_stream_from_data_in_memory"><a class="anchor" href="#_building_a_stream_from_data_in_memory"></a>Building a Stream from Data in Memory</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Creating a Stream from <strong>Arrays</strong>:</p>
<div class="ulist">
<ul>
<li>
<p>ğŸ”´ <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/Arrays.html#stream(T%5B%5D)" target="_blank" rel="noopener"><code>Arrays#stream(T[] array)</code></a> - returns a sequential <code>Stream&lt;T&gt;</code> with the specified array as its source</p>
</li>
<li>
<p>âšª <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Stream.html#of(T%2E%2E%2E)" target="_blank" rel="noopener"><code>Stream&lt;T&gt;#of(T&#8230;&#8203; values)</code></a> - returns a sequential ordered stream whose elements are the specified values</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Stream&lt;String&gt; streamOfStrings = Stream.&lt;String&gt;of("abcd", "efgh");</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Creating a Stream from <strong>a Text File</strong>:</p>
<div class="ulist">
<ul>
<li>
<p>ğŸ”´ <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/nio/file/Files.html#lines(java.nio.file.Path)" target="_blank" rel="noopener"><code>Files#lines(Path path)</code></a> - read all lines from a file as a <code>Stream&lt;String&gt;</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Path path = Path.of("src/main/resources/first-names.txt"); <i class="conum" data-value="1"></i><b>(1)</b>
try (Stream&lt;String&gt; lines = Files.lines(path)) {
    long count = lines.count(); <i class="conum" data-value="2"></i><b>(2)</b>
} catch (IOException e) {
    e.printStackTrace();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>File with 200 lines</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Returns 200</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Creating a Stream from <strong>a RegEx</strong>:</p>
<div class="ulist">
<ul>
<li>
<p>ğŸ”´ <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/regex/Pattern.html" target="_blank" rel="noopener"><code>Pattern#splitAsStream(CharSequence input)</code></a> - creates a <code>Stream&lt;String&gt;</code> from the given input sequence around matches of this pattern.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">String sentence = "the quick brown fox jumps over the lazy dog";

<i class="conum" data-value="1"></i><b>(1)</b>
String[] words = sentence.split(" ");
long count1 = Arrays.stream(words).count(); <i class="conum" data-value="3"></i><b>(3)</b>

<i class="conum" data-value="2"></i><b>(2)</b>
long count2 = Pattern.compile(" ").splitAsStream(sentence).count(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>Bad Practice:</strong> we create an array and store it in memory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>Best Practice:</strong> we do not create an array when we create a <code>âšª Stream&lt;T&gt;</code> from <code>ğŸ”´ Pattern</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns 9</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Creating an <code>âšª IntStream</code> <strong>(Stream of ASCII Codes)</strong> from a String:</p>
<div class="ulist">
<ul>
<li>
<p>ğŸ”´ <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/String.html" target="_blank" rel="noopener"><code>String#chars()</code></a> - Returns an <code>âšª IntStream</code> of int zero-extending the char values from this sequence.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">String sentence = "the quick brown fox jumps over the lazy dog";
sentence.chars()
    .mapToObj(codePoint -&gt; Character.toString(codePoint)) <i class="conum" data-value="1"></i><b>(1)</b>
    .filter(letter -&gt; !letter.equals(" "))
    .distinct().sorted().forEach(System.out::print);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Converts <code>âšª IntStream</code> to <code>âšª Stream&lt;String&gt;</code></td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Selecting</strong> elements of a Stream:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">IntStream.range(0, 30)
    .skip(10) <i class="conum" data-value="1"></i><b>(1)</b>
    .limit(10) <i class="conum" data-value="2"></i><b>(2)</b>
    .forEach(index -&gt; System.out.print(index + " ")); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Skip first 10 elements</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Take next 10 elements after skip</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Prints "10 11 12 13 14 15 16 17 18 19"</td>
</tr>
</table>
</div>
</li>
<li>
<p><strong>Closing</strong> a <code>âšª Stream&lt;T&gt;</code> with a <code>âšª Predicate&lt;? super T&gt;</code>:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Stream.html#takeWhile(java.util.function.Predicate)" target="_blank" rel="noopener"><code>takeWhile</code></a> - consume elements of the <code>âšª Stream&lt;T&gt;</code> until <code>âšª Predicate&lt;? super T&gt;</code> is <strong>true</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Stream.&lt;Class&lt;?&gt;&gt;iterate(ArrayList.class, c -&gt; c.getSuperclass())
    .takeWhile(c -&gt; c != null)
    .forEach(System.out::println);
// Prints:
class java.util.ArrayList
class java.util.AbstractList
class java.util.AbstractCollection
class java.lang.Object</code></pre>
</div>
</div>
</li>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Stream.html#dropWhile(java.util.function.Predicate)" target="_blank" rel="noopener"><code>dropWhile</code></a> - consume remaining elements of the <code>âšª Stream&lt;T&gt;</code> after <code>âšª Predicate&lt;? super T&gt;</code> becomes <strong>false</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Stream.&lt;Class&lt;?&gt;&gt;iterate(ArrayList.class, c -&gt; c.getSuperclass())
    .dropWhile(c -&gt; !c.equals(AbstractCollection.class))
    .forEach(System.out::println);
// Prints
class java.util.AbstractCollection
class java.lang.Object
null
Exception in thread "main" java.lang.NullPointerException: Cannot invoke "java.lang.Class.getSuperclass()" because "c" is null</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_converting_a_for_loop_to_a_stream"><a class="anchor" href="#_converting_a_for_loop_to_a_stream"></a>Converting a For Loop to a Stream</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The following:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">int sum = 0;
int count = 0;
for (Person person : people) {
    if (person.getAge() &gt; 20) {
        count++;
        sum += person.getAge();
    }
}
double average = 0d;
if (count &gt; 0) {
    average = sum / count;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>can be converted into:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">double average = people.stream()
    .mapToInt(Person::getAge)
    .filter(age -&gt; age &gt; 20)
    .average().orElseThrow();</code></pre>
</div>
</div>
</li>
<li>
<p>The Stream API <strong>always computes one thing</strong>. Never sacrifice the <strong>readability</strong> of your code to the <strong>performance</strong>. The performance here is measured in <strong>nanoseconds</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">double totalAmount = 0;
int frequentRenterPoints = 0;
String statement = composeHeader();
for (Rental rental : rentals) {
    totalAmount += computeRentalAmount(rental);
    frequentRenterPoints += getFrequentRenterPoints(rental);
    statement += computeStatementLine(rental);
}
statement += composeFooter(totalAmount, frequentRenterPoints);</code></pre>
</div>
</div>
<div class="paragraph">
<p>can be converted into:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">double totalAmount = rentals.stream()
    .mapToDouble(this::computeRentalAmount)
    .sum();
int frequentRenterPoints = rentals.stream()
    .mapToInt(this::getFrequentRenterPoints)
    .sum();
String statement = composeHeader();
statement += rentals.stream()
    .map(this::computeStatementLine)
    .collect(Collectors.joining());
statement += composeFooter(totalAmount, frequentRenterPoints);</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Forget about <strong>processing your data in one pass</strong> (unless you are doing <strong>an SQL request</strong>). Most of the time when you have a for loop or when you have a <code>âšª Stream&lt;T&gt;</code>, the JVM will optimize that for you and get rid of your for loop, get rid of your iteration, and you will have a zero pass of your data, just inline code, <strong>extremely performant, and extremely efficient</strong>. See <a href="https://colinchjava.github.io/2023-10-25/08-46-54-893363-fine-grained-optimizations-provided-by-jit-compiler-in-java/" target="_blank" rel="noopener">Fine-grained optimizations provided by JIT Compiler in Java</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reducing_data_to_compute_statistics"><a class="anchor" href="#_reducing_data_to_compute_statistics"></a>Reducing Data to compute Statistics</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Stream.html#reduce(java.lang.Object,java.util.function.BinaryOperator)" target="_blank" rel="noopener"><code>âšª Stream&lt;T&gt;#reduce(T identity, BinaryOperator&lt;T&gt; accumulator)</code></a> adds the Identity Element before the elements of the <code>âšª Stream&lt;T&gt;</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you have an empty <code>âšª Stream&lt;T&gt;</code>, it will <strong>return Identity Element</strong></p>
</li>
<li>
<p>If you have only one element in the <code>âšª Stream&lt;T&gt;</code>, it will <strong>return the reduction of the Identity Element and this only element</strong>:</p>
<div class="paragraph">
<p><span class="image"><img src="../_images/the-stream-api/stream-reduce.png" alt="stream reduce" width="500"></span></p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Some reduction operations <strong>do not have any Identity Element</strong> (in case for the <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/IntStream.html#min()" target="_blank" rel="noopener"><code>âšª IntStream#min()</code></a>, the <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/IntStream.html#max()" target="_blank" rel="noopener"><code>âšª IntStream#max()</code></a>, the <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/IntStream.html#average()" target="_blank" rel="noopener"><code>âšª IntStream#average()</code></a> and <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Stream.html#reduce(java.util.function.BinaryOperator)" target="_blank" rel="noopener"><code>âšª Stream&lt;T&gt;#reduce(BinaryOperator&lt;T&gt; accumulator)</code></a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<code>ğŸ”´ Optional&lt;T&gt;</code> are used by the Stream API, because in cases where we have an empty <code>âšª Stream&lt;T&gt;</code> without any Identity Element <strong>we don&#8217;t have any result</strong>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_collecting_data_from_streams_to_create_listssetsmaps"><a class="anchor" href="#_collecting_data_from_streams_to_create_listssetsmaps"></a>Collecting Data from Streams to create Lists/Sets/Maps</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">Collector</dt>
<dd>
<p>Complex object <strong>used to reduce a Stream</strong>. Can be used to gather data in <strong>collections</strong> and <strong>maps</strong> - it is called as <strong>reduction in a "mutable container"</strong> or <strong>mutable reduction</strong></p>
</dd>
<dt class="hdlist1">Downstream Collector</dt>
<dd>
<p>Collector that is passed to <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Collectors.html#groupingBy(java.util.function.Function,java.util.stream.Collector)" target="_blank" rel="noopener"><code>ğŸ”´ Collectors#groupingBy(Function&lt;? super T,? extends K&gt; classifier, Collector&lt;? super T,A,D&gt; downstream)</code></a> which is applied to the streaming of the list of values</p>
</dd>
<dt class="hdlist1">The Collector API</dt>
<dd>
<p>Uses the <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Stream.html#collect(java.util.stream.Collector)" target="_blank" rel="noopener"><code>Stream#collect(Collector&lt;? super T,A,R&gt; collector)</code></a> that takes <code>âšª Collector&lt;T,A,R&gt;</code> implementation as a parameter:</p>
<div class="ulist">
<ul>
<li>
<p>Use <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Collectors.html" target="_blank" rel="noopener"><code>ğŸ”´ Collectors</code></a> class and its factory methods</p>
</li>
<li>
<p>You can create your own collectors, but it is complex and tricky</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Bad Practice
List&lt;Person&gt; people = new ArrayList&lt;&gt;();
List&lt;Person&gt; peopleFromNewYork = new ArrayList&lt;&gt;(); <i class="conum" data-value="1"></i><b>(1)</b>
people.stream()
    .filter(p -&gt; p.getCity().equals("New York"))
    .forEach(p -&gt; peopleFromNewYork.add(p));

// Best Practice
List&lt;Person&gt; people = new ArrayList&lt;&gt;();
List&lt;Person&gt; peopleFromNewYork = people.stream()
    .filter(p -&gt; p.getCity().equals("New York"))
    .collect(Collectors.toList()); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creating a <code>âšª List&lt;E&gt;</code> to store the result</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Using <code>âšª Collector&lt;T,A,R&gt;</code> to store the result in <code>âšª List&lt;E&gt;</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_parallelism_in_the_stream_api"><a class="anchor" href="#_parallelism_in_the_stream_api"></a>Parallelism in the Stream API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can make a regular <code>âšª Stream&lt;T&gt;</code> a parallel <code>âšª Stream&lt;T&gt;</code> <strong>in two ways</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>by calling <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/BaseStream.html#parallel()" target="_blank" rel="noopener"><code>âšª BaseStream&lt;T,S extends BaseStream&lt;T,S&gt;&gt;#parallel()</code></a> method on existing <code>âšª Stream&lt;T&gt;</code></p>
</li>
<li>
<p>by calling <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/Collection.html#parallelStream()"><code>âšª Collection&lt;E&gt;#parallelStream()</code></a> method instead of calling <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/Collection.html#stream()"><code>âšª Collection&lt;E&gt;#stream()</code></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These intermediate operations are going to set <strong>a special bit</strong> in the <code>âšª Stream&lt;T&gt;</code> that will <strong>trigger the computations in parallel when you call your terminal operation</strong>.</p>
</div>
<div class="paragraph">
<p>After terminal operation is called, the <code>âšª Stream&lt;T&gt;</code> implementation will check this special bit:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>if it is set to 1</strong>, then the computation will happen <strong>in parallel</strong> and will trigger special algorithms for that</p>
</li>
<li>
<p><strong>otherwise</strong> it will be processed <strong>sequentially</strong></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://openjdk.org/projects/code-tools/jmh/" target="_blank" rel="noopener"><strong>JMH (Java Microbenchmark Harness)</strong></a></dt>
<dd>
<p>Standard tool to measure the performances of your Java code. You can find JMH Template project <a href="https://github.com/p-marcin/jmh-template" target="_blank" rel="noopener">here</a>.</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To proper measure the performance of a Java application you first need to run it <strong>a certain number of times (warmup)</strong>, because within JVM there is a special just-in-time C2 compiler that can optimize your code a lot.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_the_best_performance_gains_from_parallel_streamt"><a class="anchor" href="#_getting_the_best_performance_gains_from_parallel_streamt"></a>Getting the best performance gains from parallel <code>âšª Stream&lt;T&gt;</code></h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Beware, you&#8217;ll have <strong>two unboxing</strong> and <strong>one boxing</strong> here (which have an impact on performance!):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Integer j = 3;
Integer l = 4;
Integer k = j + l;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, iterating and doing some operation over <code>int[]</code> will be <strong>much faster</strong> than over <code>ğŸ”´ Integer[]</code> (due to unboxing and boxing).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each physical core of the CPU access <strong>two levels of cache</strong>, which are <strong>private</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>L1 - the first level of cache (<strong>small, very fast</strong>)</p>
</li>
<li>
<p>L2 - the second level of cache (<strong>bigger, little slower</strong>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L3 - the third level of cache is <strong>shared by all physical cores</strong> (<strong>bigger, little slower than L2</strong>).</p>
</div>
<div class="paragraph">
<p>Main memory lives <strong>outside the CPU</strong> and is accessed <strong>much slower</strong> than L3:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/the-stream-api/cpu-caches.png" alt="cpu caches" width="450">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">How does a core of CPU access data from the main memory?</dt>
<dd>
<p>This data will have to be <strong>transferred</strong> first to the L3 cache, then to the L2 cache, and then to the L1 cache <strong>before being available</strong> by this core of CPU.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The memory is <strong>not read in a random way</strong>. If a core of CPU wants to access just an <code>int</code>, it will transfer <strong>line of memory</strong>, not just an <code>int</code>. The memory is <strong>transferred line by line</strong> from the main memory to the different levels of cache. Each line is typically <strong>64</strong> bytes (<strong>8</strong> <code>long</code> or <strong>16</strong> <code>int</code>).</p>
</div>
<div class="paragraph">
<p>When we have an array of references to the instance of the <code>ğŸ”´ Integer</code> which are going to hold the values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In one read operation we are only going to <strong>transfer the references to this object</strong>.</p>
</li>
<li>
<p>And then to get all the values it may be <strong>several read</strong> to maximum <strong>16</strong> reads.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This is called <strong>Pointer Chasing</strong> which you need to avoid. To get all the values, we have to <strong>follow pointers</strong> to other places in the memory which has a cost due to the way that data is transferred from the main memory to the cache of the CPU.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Iterating on a <code>ğŸŸ¢ LinkedList</code> will imply <strong>much more Pointer Chasing</strong> than iterating on an <code>ğŸŸ¢ ArrayList</code>. <code>ğŸŸ¢ LinkedList</code> does not store references to the <code>ğŸ”´ Integer</code> in an array. It stores them in <strong>a linked list of node objects</strong>. So first, you need to get the first reference to the first node object, and then you need to <strong>follow two pointers</strong>: the first one to the next node object and the second one to the <code>ğŸ”´ Integer</code> itself.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Cache Miss</dt>
<dd>
<p>Whenever the core of a CPU needs a value and that value turns out not to be in the cache. During the Cache Miss, if the value is not in the L2 cache or L3 cache, then the CPU may decide to <strong>suspend the thread</strong> that is executing this computation and <strong>replace it by another thread</strong>. This is a <strong>much bigger performance hit</strong> than just Pointer Chasing, but it is still a consequence of Pointer Chasing.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is why <code>ğŸŸ¢ LinkedList</code> is called <strong>cache-unfriendly structure</strong>, whereas <code>ğŸŸ¢ ArrayList</code> is called <strong>cache-friendly structure</strong>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_forkjoin_framework_implementation_of_parallel_streamt"><a class="anchor" href="#_forkjoin_framework_implementation_of_parallel_streamt"></a>Fork/Join Framework implementation of parallel <code>âšª Stream&lt;T&gt;</code></h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Fork/Join Framework has been <strong>introduced in Java 7</strong> and <strong>slightly modified in Java 8</strong>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Going parallel means that this task is going to be <strong>split into subtasks</strong> and each subtask is going to <strong>produce a partial result</strong> (fork step). When those partial results have been computed, they are going to be <strong>sent back to the main task</strong> that has the responsibility of <strong>joining them</strong> (join step).</p>
</div>
<div class="paragraph">
<p>All those tasks are <strong>sent to a special pool of thread</strong> called <strong>Fork/Join Pool</strong> and this pool has special capabilities to enable the computations of those <strong>subtasks in parallel</strong>.</p>
</div>
<div class="paragraph">
<p>Fork/Join Framework decides whether the task is <strong>too big and should be split</strong>, or <strong>small enough and should be computed</strong>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Fork/Join Pool</dt>
<dd>
<p>Is a pool of threads, instance of the <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/concurrent/ForkJoinPool.html" target="_blank" rel="noopener"><code>ğŸŸ¢ ForkJoinPool</code></a></p>
<div class="ulist">
<ul>
<li>
<p>created when <strong>the JVM is created</strong></p>
</li>
<li>
<p>there is <strong>only one common</strong> <code>ğŸŸ¢ ForkJoinPool</code> in the JVM since Java 8</p>
</li>
<li>
<p>it is used for <strong>all</strong> the parallel streams</p>
</li>
<li>
<p>the size is <strong>fixed by the number of virtual cores</strong> (not necessarily a good thing) and can be changed with <code>java.util.concurrent.ForkJoinPool.common.parallelism</code> system property</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Suppose we have a common Fork/Join Pool with <strong>2</strong> threads in it. Each thread is also associated with a waiting queue that can accept tasks. Suppose we have a task to compute:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The first step is to split this task (<em>A</em>) into subtasks (<em>A11</em>, <em>A12</em>).</p>
</li>
<li>
<p>Since parent task (<em>A</em>) is waiting for the partial results computed by its subtasks, it will be <strong>put at the end of the waiting queue</strong> thus freeing the first thread 1ï¸âƒ£ that is going to be able to handle the task <em>A11</em>.</p>
</li>
<li>
<p>Since second thread 2ï¸âƒ£ is not working, it is able to <strong>steal some tasks from another waiting queue</strong>. So second thread 2ï¸âƒ£ will steal a task <em>A12</em> from first thread 1ï¸âƒ£, that is busy with <em>A11</em> task. <strong>All threads will be busy</strong>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Fork/Join Framework implements a trick that is quite classical in concurrent programming that is called <strong>work stealing</strong>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Once all subtasks will finish computation, the results will be passed to <em>A</em> task which will <strong>apply the reduce operator</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You need to bench your own computation to be able to tell where your <strong>sweet spot</strong> is going to be in your use case. E.g. computing the sum of 10 integers in array is <strong>much faster sequentially than in parallel</strong>, however computing the sum of several millions integers in array will be <strong>much faster in parallel</strong>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
You also need to check that on a machine that is <strong>as close as possible</strong> to your production machine.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Synchronization</dt>
<dd>
<p>A feature within the Java language which <strong>prevents two threads from executing the same piece of code</strong>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In the Stream API there are operations (intermediate and terminal) that need to exchange data or exchange information with the other threads and perform <strong>hidden synchronization</strong> which is a <strong>bottleneck</strong>, e.g. <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Stream.html#findFirst()" target="_blank" rel="noopener"><code>âšª Stream&lt;T&gt;#findFirst()</code></a> (<a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Stream.html#findAny()" target="_blank" rel="noopener"><code>âšª Stream&lt;T&gt;#findAny()</code></a> will provide you much better performance in parallel) and <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Stream.html#limit(long)"><code>âšª Stream&lt;T&gt;#limit(long maxSize)</code></a> methods.</p>
</div>
<div class="paragraph">
<p>If your <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/function/BinaryOperator.html"><code>âšª BinaryOperator&lt;T&gt;</code></a> from <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/stream/Stream.html#reduce(java.util.function.BinaryOperator)" target="_blank" rel="noopener"><code>âšª Stream&lt;T&gt;#reduce</code></a> method is <strong>not associative</strong>, then you are going to <strong>compute wrong results</strong> in both: sequential and parallel computing. In parallel, you can also get <strong>different results</strong> each time.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Associative</dt>
<dd>
<p>Means that first computation gives out the same result as the second computation. Example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">stream.reduce(0, (i1, i2) -&gt; i1*i1 + i2*i2); <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Given: <code>[1, 1, 1, 1]</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It should return <code>4</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Since it is not associative <code>âšª BinaryOperator&lt;T&gt;</code>, it will compute <code>2</code> (<code>1</code>+<code>1</code>), then <code>5</code> (<code>4</code>+<code>1</code>), and it will return <code>26</code> (<code>25</code>+<code>1</code>)</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You can display the thread executing your parallel stream with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Set&lt;String&gt; threadNames = ConcurrentHashMap.newKeySet();
stream.parallel()
    .(...)
    .peek(i -&gt; threadNames.add(Thread.currentThread().getName()))
    .(...);
threadNames.forEach(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can execute a parallel stream in a custom <code>ğŸŸ¢ ForkJoinPool</code>, display the threads executing your parallel stream and count the number of tasks each thread executed with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Map&lt;String, Long&gt; threadMap = new ConcurrentHashMap&lt;&gt;();
Callable&lt;Integer&gt; task = () -&gt; {
    int result = stream.parallel()
        .(...)
        .peek(i -&gt; threadMap.merge(Thread.currentThread().getName(), 1L, Long::sum))
        .(...);
    return result;
};

ForkJoinPool forkJoinPool = new ForkJoinPool(4); <i class="conum" data-value="1"></i><b>(1)</b>
ForkJoinTask&lt;Integer&gt; submit = forkJoinPool.submit(task);
submit.get();
threadMap.forEach((name, n) -&gt; System.out.println(name + " -&gt; " + n));
forkJoinPool.shutdown();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Custom <code>ğŸŸ¢ ForkJoinPool</code> with 4 threads</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_choosing_the_right_sources_of_data_to_efficiently_go_parallel"><a class="anchor" href="#_choosing_the_right_sources_of_data_to_efficiently_go_parallel"></a>Choosing the right sources of data to efficiently go parallel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Fork step in Fork/Join Framework works best based on two assumptions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The number of elements is <strong>known before processing them</strong>. These sources of data do not meet this condition:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/Iterator.html"><code>âšª Iterator&lt;E&gt;</code></a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/regex/Pattern.html" target="_blank" rel="noopener"><code>ğŸ”´ Pattern</code></a></p>
</li>
<li>
<p>Lines of a text file</p>
</li>
</ul>
</div>
</li>
<li>
<p>Reaching the <strong>center of the data</strong> must be <strong>easy, reliable and efficient</strong>. This source of data does not meet this condition:</p>
<div class="ulist">
<ul>
<li>
<p><code>ğŸŸ¢ LinkedList</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Fork/Join Framework splits the array in two pieces and <strong>doesn&#8217;t know</strong> if there is <strong>the same amount of data</strong> in the first half and in the second half. This information is not available, <strong>unless you count all the elements</strong>, one by one, in each half. <strong>The Framework doesn&#8217;t do that</strong>, because it would be too costly.</p>
</div>
<div class="paragraph">
<p>Those two halves are going to be split again, and again, and again. Some of the segments of this array are going to be empty. Become higher and higher as the number of splitting increases. <strong>This is a problem with <code>âšª Set&lt;E&gt;</code>-like structures</strong>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Sizeable</dt>
<dd>
<p>The number of elements of the source is known. All the collections and the arrays are sizeable, but all the patterns, lines and iterators are not sizeable.</p>
</dd>
<dt class="hdlist1">Subsizeable</dt>
<dd>
<p>The number of elements in both parts of a split source is known. Sets are sizeable, but they are not subsizeable.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Processing data from a <code>âšª List&lt;E&gt;</code> is <strong>much faster</strong> than the processing data from a <code>âšª Set&lt;E&gt;</code> because iterating over the elements of a <code>âšª List&lt;E&gt;</code> is faster than iterating over the elements of a <code>âšª Set&lt;E&gt;</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Going parallel as a <code>âšª List&lt;E&gt;</code> will bring you <strong>more performance gain</strong> than going parallel in a <code>âšª Set&lt;E&gt;</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You may have data to process that, in fact, is <strong>not well spread</strong> over all the <strong>buckets of the array</strong> that is backing your <code>âšª Set&lt;E&gt;</code> (e.g. lines of strings that all return 0 hash code will be handled by <strong>only one thread</strong>).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Are you sure that your threads should be used to compute your streams in parallel?</dt>
<dd>
<p>In case of a web application your threads are used to serve your HTTP clients, so <strong>you don&#8217;t want those threads to be used for anything else</strong>, including parallel streams. The same goes for threads that are used for SQL transactions. <strong>Threads are precious resources</strong>.</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
  </body>
</html>
