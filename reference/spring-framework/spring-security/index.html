<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Security :: Javowiec.pl</title>
    <link rel="canonical" href="https://javowiec.pl/reference/spring-framework/spring-security/index.html">
    <meta name="generator" content="Antora 3.1.10">
<link rel="stylesheet" href="../../../_/css/site.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"/>
<link rel="stylesheet" href="../../../_/css/doc-extension.css"/>
<link rel="stylesheet" href="../../../_/css/header-extension.css"/>
<link rel="stylesheet" href="../../../_/css/docsearch-extension.css"/>
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://javowiec.pl">
          <img id="navbar-logo" src="../../../_/img/favicon.ico" alt="Logo" />
          <span id="navbar-title">Javowiec.pl</span>
      </a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search">
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Projects</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/p-marcin/dev-cheat-sheets" target="_blank">Repository</a>
            <a class="navbar-item" href="https://github.com/p-marcin/dev-cheat-sheets/issues" target="_blank">Issue Tracker</a>
            <hr class="navbar-divider">
            <a class="navbar-item" href="https://github.com/p-marcin/java-dev-vm" target="_blank">Java DEV VM</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="reference" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../../index.html">DEV Cheat Sheets</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../java/index.html">‚òï Java</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">API</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../java/api/lambda-expression.html">Lambda Expression</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../java/api/the-stream-api/the-stream-api.html">The Stream API</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../java/api/the-stream-api/parallelism.html">Parallelism</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../java/concepts/concepts.html">Concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../java/concepts/microservices.html">Microservices</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../java/concepts/reactive-programming.html">Reactive Programming</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">‚òòÔ∏è Spring Framework</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../concepts.html">Concepts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../spring-boot.html">Spring Boot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../servlet-stack/index.html">Servlet Stack</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../servlet-stack/spring-webmvc.html">Spring WebMVC</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../servlet-stack/spring-data-jpa.html">Spring Data JPA</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../servlet-stack/spring-web-client.html">Spring WebClient</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../reactive-stack/index.html">Reactive Stack</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../reactive-stack/spring-webflux.html">Spring WebFlux</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../reactive-stack/spring-data-r2dbc.html">Spring Data R2DBC</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Spring Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="spring-authorization-server.html">Spring Authorization Server</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="spring-resource-server.html">Spring Resource Server</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../spring-boot-test/index.html">Spring Boot Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../spring-boot-test/spring-webmvc-test.html">Spring WebMVC Test</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../spring-boot-test/spring-data-jpa-test.html">Spring Data JPA Test</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../utilities/index.html">Utilities</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../utilities/thymeleaf.html">Thymeleaf</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../utilities/h2-database.html">H2 Database</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../utilities/lombok.html">Lombok</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../utilities/mapstruct.html">MapStruct</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../utilities/spring-boot-devtools.html">Spring Boot DevTools</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../utilities/debug.html">Debugging techniques</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../web/index.html">üï∏Ô∏è Web</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../database/index.html">üßÆ Database</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../database/postgresql-ha.html">PostgreSQL HA - Bitnami</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../server/index.html">‚öôÔ∏è Server</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../server/open-liberty.html">Open Liberty</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../linux/index.html">üñ•Ô∏è Linux</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../linux/coreutils/index.html">Coreutils (file, shell, text manipulation)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../linux/jq.html">Jq: JSON Stream Processor</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../linux/sed.html">Sed: Stream Editor</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../asciidoc/index.html">üÖ∞Ô∏è AsciiDoc</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">DEV Cheat Sheets</a></li>
    <li><a href="../index.html">‚òòÔ∏è Spring Framework</a></li>
    <li><a href="index.html">Spring Security</a></li>
  </ul>
</nav>
<div class="edit-this-page"><a href="https://github.com/p-marcin/dev-cheat-sheets/blob/main/docs/modules/spring-framework/pages/spring-security/index.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Spring Security</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><a class="image" href="https://docs.spring.io/spring-security/reference" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/Spring%20Documentation-2088E9?logo=quickLook&amp;logoColor" alt="Spring%20Documentation 2088E9?logo=quickLook&amp;logoColor"></a></span>
<span class="image"><a class="image" href="https://docs.spring.io/spring-boot/reference/web/spring-security.html" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/Spring%20Boot%20Documentation-2088E9?logo=quickLook&amp;logoColor" alt="Spring%20Boot%20Documentation 2088E9?logo=quickLook&amp;logoColor"></a></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="spring-authorization-server.html" class="xref page">Spring Authorization Server</a></p>
</li>
<li>
<p><a href="spring-resource-server.html" class="xref page">Spring Resource Server</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_maven_dependencies"><a class="anchor" href="#_maven_dependencies"></a>Maven Dependencies</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
    &lt;artifactId&gt;spring-security-test&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Just by adding the dependency, Spring Boot will provide us <strong>sensible defaults</strong>. For example, it will <strong>autoconfigure Basic HTTP Authentication</strong> and secure all REST API endpoints.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Basic HTTP Auth should be used with HTTPS, because username and password are sent over the internet as <strong>base64</strong> encoded and <strong>without HTTPS they can be easily decoded</strong>. It is discouraged to use Basic HTTP Auth in an Enterprise project.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_http_auth"><a class="anchor" href="#_basic_http_auth"></a>Basic HTTP Auth</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_calling_rest_api_endpoint_with_basic_http_auth"><a class="anchor" href="#_calling_rest_api_endpoint_with_basic_http_auth"></a>Calling REST API endpoint with Basic HTTP Auth</h3>
<div class="paragraph">
<p>If you&#8217;ll just send a GET request to <code>http://localhost:8080/api/v1/resource</code>, you&#8217;ll get Response Status Code: <strong>401 Unauthorized</strong>.</p>
</div>
<div class="paragraph">
<p>Basic HTTP Auth requires a header in the request called <code>Authorization</code> with value: <code>Basic dXNlcjphM2JhNmYyOS0xMGU0LTQ5OTctOTg4Mi0yMjM0ODg4M2Q5NTQ=</code> where after <code>Basic</code> there is <strong>base64 encoded username and password</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Decoding base64 string</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ echo "dXNlcjphM2JhNmYyOS0xMGU0LTQ5OTctOTg4Mi0yMjM0ODg4M2Q5NTQ=" | base64 --decode
user:a3ba6f29-10e4-4997-9882-22348883d954</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Encoding base64 string</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ echo -n "user:a3ba6f29-10e4-4997-9882-22348883d954" | base64
dXNlcjphM2JhNmYyOS0xMGU0LTQ5OTctOTg4Mi0yMjM0ODg4M2Q5NTQ=</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_customizing_username_and_password"><a class="anchor" href="#_customizing_username_and_password"></a>Customizing username and password</h3>
<div class="paragraph">
<p>By default, Spring will create a new password <strong>on each deployment</strong>.</p>
</div>
<div class="paragraph">
<p>You can customize Spring Security username and password with these properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">spring.security.user.name=my-user
spring.security.user.password=my-password</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_resttemplate_with_basic_http_auth"><a class="anchor" href="#_using_resttemplate_with_basic_http_auth"></a>Using <code>üü¢ RestTemplate</code> with Basic HTTP Auth</h3>
<div class="paragraph">
<p>You&#8217;ll have to invoke <a href="https://docs.spring.io/spring-boot/api/java/org/springframework/boot/web/client/RestTemplateBuilder.html#basicAuthentication(java.lang.String,java.lang.String)" target="_blank" rel="noopener"><code>üü¢ RestTemplateBuilder#basicAuthentication(String username,
String password)</code></a> when configuring Bean <a href="../servlet-stack/spring-web-client.html#_externalize_base_uri" class="xref page">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_http_get_with_basic_http_auth"><a class="anchor" href="#_testing_http_get_with_basic_http_auth"></a>Testing HTTP GET with Basic HTTP Auth</h3>
<div class="paragraph">
<p>An example how Basic HTTP Auth can be added to the test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">mockMvc.perform(get("/api/v1/resource")
            .with(httpBasic("my-user", "my-password")) <i class="conum" data-value="1"></i><b>(1)</b>
            .accept(MediaType.APPLICATION_JSON))
    .andExpect(status().isOk())
    .andExpect(content().contentType(MediaType.APPLICATION_JSON))
    .andExpect(jsonPath("$.content.length()", is(3)));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This way we can add <code>Authorization</code> header to the request</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_testing_http_post_with_basic_http_auth"><a class="anchor" href="#_testing_http_post_with_basic_http_auth"></a>Testing HTTP POST with Basic HTTP Auth</h3>
<div class="paragraph">
<p>For HTTP POST simply adding to the test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.with(httpBasic("my-user", "my-password"))</code></pre>
</div>
</div>
<div class="paragraph">
<p>is not enough. You&#8217;ll get Response Status Code: <strong>403 Forbidden</strong> due to: <code>Invalid CSRF token found for http://localhost/api/v1/resource</code>.</p>
</div>
<div class="paragraph">
<p>You can ignore CSRF token only for REST API by creating a <code>üü¢ SecurityConfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity httpSecurity) throws Exception {
        httpSecurity.authorizeHttpRequests(authorize -&gt; authorize.anyRequest().authenticated()) <i class="conum" data-value="1"></i><b>(1)</b>
                .httpBasic(Customizer.withDefaults()) <i class="conum" data-value="2"></i><b>(2)</b>
                .csrf(csrf -&gt; csrf.ignoringRequestMatchers("/api/**")); <i class="conum" data-value="3"></i><b>(3)</b>
        return httpSecurity.build();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Require any request to be authenticated</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Setup HTTP Basic Auth with the defaults</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Do not require CSRF Token on <code>/api/**</code> urls</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If your test is annotated with <a href="https://docs.spring.io/spring-boot/api/java/org/springframework/boot/test/context/SpringBootTest.html" target="_blank" rel="noopener"><code>@SpringBootTest</code></a>, then you need to create <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/test/web/servlet/MockMvc.html" target="_blank" rel="noopener"><code>üî¥ MockMvc</code></a> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MockMvc mockMvc = MockMvcBuilders.webAppContextSetup(wac)
    .apply(springSecurity()) <i class="conum" data-value="1"></i><b>(1)</b>
    .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure <code>üî¥ MockMvc</code> to use Spring Security</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If your test is annotated with <a href="https://docs.spring.io/spring-boot/api/java/org/springframework/boot/test/autoconfigure/web/servlet/WebMvcTest.html" target="_blank" rel="noopener"><code>@WebMvcTest</code></a>, then you need to import <code>üü¢ SecurityConfig</code> by annotating the test class with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Import(SecurityConfig.class)</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_oauth_2_0_and_jwt"><a class="anchor" href="#_oauth_2_0_and_jwt"></a>OAuth 2.0 and JWT</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">OAuth 2.0</dt>
<dd>
<p><strong>Authorization Framework</strong> used to grant <strong>limited access</strong> to resources without full access to the account. It allows you <strong>to grant access to a third party application</strong> to <strong>act on your behalf</strong>.</p>
</dd>
<dt class="hdlist1">OAuth Roles</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><strong>Client</strong> - the application requesting access</p>
</li>
<li>
<p><strong>Resource Owner</strong> - the user who wishes to grant an application (Client) access</p>
</li>
<li>
<p><a href="spring-authorization-server.html" class="xref page"><strong>Authorization Server</strong></a> - verifies the identity of the user then issues access tokens to the application</p>
</li>
<li>
<p><a href="spring-resource-server.html" class="xref page"><strong>Resource Server</strong></a> - the resource to access</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Client Credentials Flow</dt>
<dd>
<p>Most common OAuth <a href="https://auth0.com/docs/get-started/authentication-and-authorization-flow/which-oauth-2-0-flow-should-i-use">Authorization Flow</a> for RESTful APIs. It is used by services, where the user is a service role.</p>
<div class="imageblock">
<div class="content">
<img src="../_images/oauth2-client-credentials-flow-with-jwt.png" alt="oauth2 client credentials flow with jwt" width="600">
</div>
<div class="title">Figure 1. Client Credentials Flow with JWT</div>
</div>
</dd>
<dt class="hdlist1">JWT</dt>
<dd>
<p><strong>JSON Web Token</strong>. It contains <strong>user information</strong> and <strong>authorized roles</strong> (scopes). It has three parts: <strong>Header</strong>, <strong>Payload</strong> (data) and <strong>Signature</strong>. All 3 parts are tokenized using <strong>base64 encoding</strong>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
HTTP / REST are <strong>stateless</strong> - each request is <strong>self-contained</strong>. Unlike Web Applications which often use <strong>session id&#8217;s stored in cookies</strong>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>JWT is <strong>signed</strong> which <strong>prevents clients from altering the contents</strong> of the JWT. It can be signed using a number of techniques:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Symmetric encryption</strong> - uses single key to sign, requires key to be shared</p>
</li>
<li>
<p><strong>Asymmetric encryption</strong> - uses Public and Private Keys (known as <strong>Key Pair</strong>)</p>
<div class="ulist">
<ul>
<li>
<p><strong>Private Key</strong> is used to generate signature and is not shared</p>
</li>
<li>
<p><strong>Public Key</strong> is shared and is used to verify signature</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">JWT Verification</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Authorization Server <strong>signs JWT</strong> using the <strong>Private Key</strong></p>
</li>
<li>
<p>The Resource Server <strong>requests the Public Key</strong> from the Authorization Server</p>
</li>
<li>
<p>Using the <strong>Public Key</strong> the Resource Server <strong>verifies the signature of the JWT</strong></p>
</li>
<li>
<p>The Resource Server can <strong>cache the Public Key</strong> for verification of future requests</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Once the Resource Server has the Public Key, JWT can be validated <strong>without additional requests</strong> from the Authorization Server.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_oauth_vs_basic_http_auth"><a class="anchor" href="#_oauth_vs_basic_http_auth"></a>OAuth vs Basic HTTP Auth</h3>
<div class="ulist">
<ul>
<li>
<p>Basic HTTP Auth requires user credentials to be <strong>shared with every resource</strong></p>
</li>
<li>
<p>Basic HTTP Auth sends user credentials <strong>unencrypted</strong> in HTTP header and can be <strong>compromised</strong></p>
</li>
<li>
<p>With OAuth user credentials are <strong>only shared with Authorization Server</strong></p>
</li>
<li>
<p>User credentials <strong>cannot be obtained</strong> from Authorization Token</p>
</li>
<li>
<p>Basic HTTP Auth has <strong>no concept of security roles</strong></p>
</li>
<li>
<p>With OAuth 2.0 security roles are <strong>defined in scopes</strong> and <strong>passed in Authorization Token</strong></p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When we&#8217;re dealing with security roles, we can <strong>grant access</strong> to resources as needed or <strong>deny access</strong> when appropriate.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_calling_rest_api_endpoint_with_oauth_2_0"><a class="anchor" href="#_calling_rest_api_endpoint_with_oauth_2_0"></a>Calling REST API endpoint with OAuth 2.0</h3>
<div class="paragraph">
<p>You&#8217;ll need Maven Dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>and these properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:9000
spring.security.oauth2.client.registration.springauth.client-id=oidc-client
spring.security.oauth2.client.registration.springauth.client-secret=secret
spring.security.oauth2.client.registration.springauth.scope[0]=message.read
spring.security.oauth2.client.registration.springauth.scope[1]=message.write
spring.security.oauth2.client.registration.springauth.authorization-grant-type=client_credentials
spring.security.oauth2.client.registration.springauth.provider=springauth
spring.security.oauth2.client.provider.springauth.authorization-uri=http://localhost:9000/oauth2/authorize
spring.security.oauth2.client.provider.springauth.token-uri=http://localhost:9000/oauth2/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, you need to add <code>@Bean</code> for <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/client/OAuth2AuthorizedClientManager.html" target="_blank" rel="noopener"><code>‚ö™ OAuth2AuthorizedClientManager</code></a> which will be <strong>responsible for the overall management</strong> of <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/client/OAuth2AuthorizedClient.html" target="_blank" rel="noopener"><code>üü¢ OAuth2AuthorizedClient</code></a>. The primary responsibilities include:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Authorizing (or re-authorizing) an OAuth 2.0 Client</strong> by leveraging an <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/client/OAuth2AuthorizedClientProvider.html" target="_blank" rel="noopener"><code>‚ö™ OAuth2AuthorizedClientProvider</code></a></p>
</li>
<li>
<p><strong>Delegating the persistence</strong> of an <code>üü¢ OAuth2AuthorizedClient</code>, typically using an <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/client/OAuth2AuthorizedClientService.html" target="_blank" rel="noopener"><code>‚ö™ OAuth2AuthorizedClientService</code></a> or <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/client/web/OAuth2AuthorizedClientRepository.html" target="_blank" rel="noopener"><code>‚ö™ OAuth2AuthorizedClientRepository</code></a></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class RestTemplateBuilderConfig {

    // ...

    @Bean
    OAuth2AuthorizedClientManager authorizedClientManager(ClientRegistrationRepository clientRegistrationRepository, <i class="conum" data-value="1"></i><b>(1)</b>
            OAuth2AuthorizedClientService authorizedClientService) {
        OAuth2AuthorizedClientProvider authorizedClientProvider = OAuth2AuthorizedClientProviderBuilder.builder()
                .clientCredentials()
                .build(); <i class="conum" data-value="2"></i><b>(2)</b>

        AuthorizedClientServiceOAuth2AuthorizedClientManager authorizedClientServiceAuthorizedClientManager =
                new AuthorizedClientServiceOAuth2AuthorizedClientManager(
                clientRegistrationRepository, authorizedClientService); <i class="conum" data-value="3"></i><b>(3)</b>
        authorizedClientServiceAuthorizedClientManager.setAuthorizedClientProvider(authorizedClientProvider);
        return authorizedClientServiceAuthorizedClientManager;
    }

    // ...

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/client/registration/ClientRegistrationRepository.html" target="_blank" rel="noopener"><code>‚ö™ ClientRegistrationRepository</code></a> checks if client <code>registrationId</code> provided in authorization request is present in registration repository (enriched from registration properties)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>‚ö™ OAuth2AuthorizedClientProvider</code> is <strong>a strategy</strong> for authorizing (or re-authorizing) an OAuth 2.0 Client. Implementations will typically implement a specific <strong>authorization grant type</strong>. Here we build <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/client/ClientCredentialsOAuth2AuthorizedClientProvider.html" target="_blank" rel="noopener"><code>üü¢ ClientCredentialsOAuth2AuthorizedClientProvider</code></a> which is an implementation for <code>client_credentials</code> grant.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/client/AuthorizedClientServiceOAuth2AuthorizedClientManager.html" target="_blank" rel="noopener"><code>üî¥ AuthorizedClientServiceOAuth2AuthorizedClientManager</code></a> is an implementation of <code>‚ö™ OAuth2AuthorizedClientManager</code> which persist <code>üü¢ OAuth2AuthorizedClient</code>:
<div class="ulist">
<ul>
<li>
<p>By default, when an authorization attempt <strong>succeeds</strong>, the <code>üü¢ OAuth2AuthorizedClient</code> will be <strong>saved</strong> in the <code>‚ö™ OAuth2AuthorizedClientService</code>.</p>
</li>
<li>
<p>By default, when an authorization attempt <strong>fails</strong> due to an <code>invalid_grant</code> error, the previously saved <code>üü¢ OAuth2AuthorizedClient</code> will be <strong>removed</strong> from the <code>‚ö™ OAuth2AuthorizedClientService</code>.</p>
</li>
</ul>
</div></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You&#8217;ll also need to implement <code>@Component</code> for <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/http/client/ClientHttpRequestInterceptor.html" target="_blank" rel="noopener"><code>‚ö™ ClientHttpRequestInterceptor</code></a> which allows to <strong>modify the outgoing request and/or the incoming response</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Component
public class OAuthClientInterceptor implements ClientHttpRequestInterceptor {

    private final OAuth2AuthorizedClientManager authorizedClientManager;

    private final ClientRegistration clientRegistration;

    private final Authentication principal;

    public OAuthClientInterceptor(OAuth2AuthorizedClientManager authorizedClientManager,
            ClientRegistrationRepository clientRegistrationRepository) {
        this.authorizedClientManager = authorizedClientManager; <i class="conum" data-value="1"></i><b>(1)</b>
        this.clientRegistration = clientRegistrationRepository.findByRegistrationId("springauth"); <i class="conum" data-value="2"></i><b>(2)</b>
        principal = createPrincipal();
    }

    @Override
    public ClientHttpResponse intercept(HttpRequest request, byte[] body,
            ClientHttpRequestExecution execution) throws IOException {
        OAuth2AuthorizeRequest authorizeRequest = OAuth2AuthorizeRequest.withClientRegistrationId(
                clientRegistration.getRegistrationId()).principal(principal).build(); <i class="conum" data-value="3"></i><b>(3)</b>

        OAuth2AuthorizedClient authorizedClient = authorizedClientManager.authorize(authorizeRequest); <i class="conum" data-value="4"></i><b>(4)</b>

        if (isNull(authorizedClient)) {
            throw new IllegalStateException("Missing credentials");
        }

        request.getHeaders().add(HttpHeaders.AUTHORIZATION, "Bearer " + authorizedClient.getAccessToken().getTokenValue()); <i class="conum" data-value="5"></i><b>(5)</b>
        return execution.execute(request, body); <i class="conum" data-value="6"></i><b>(6)</b>
    }

    private Authentication createPrincipal() {
        return new Authentication() {
            @Override
            public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {
                return List.of();
            }

            @Override
            public Object getCredentials() {
                return null;
            }

            @Override
            public Object getDetails() {
                return null;
            }

            @Override
            public Object getPrincipal() {
                return this;
            }

            @Override
            public boolean isAuthenticated() {
                return true;
            }

            @Override
            public void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException {

            }

            @Override
            public String getName() {
                return clientRegistration.getClientId();
            }
        };
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>‚ö™ OAuth2AuthorizedClientManager</code> from previous step.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>‚ö™ ClientRegistrationRepository</code> returns <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/client/registration/ClientRegistration.html" target="_blank" rel="noopener"><code>üî¥ ClientRegistration</code></a> <strong>enriched</strong> with our <code>springauth</code> registration properties.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/client/OAuth2AuthorizeRequest.html" target="_blank" rel="noopener"><code>üî¥ OAuth2AuthorizeRequest</code></a> represents <strong>a request</strong> the <code>‚ö™ OAuth2AuthorizedClientManager</code> <strong>uses to authorize (or re-authorize) the client</strong> identified by the provided client <code>registrationId</code> (<code>springauth</code>) and principal (<code>oidc-client</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>‚ö™ OAuth2AuthorizedClientManager</code> returns <code>üü¢ OAuth2AuthorizedClient</code> after <strong>successful authorization</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>üü¢ OAuth2AuthorizedClient</code> <strong>contains JWT</strong> which we can include in the <code>Authorization</code> <strong>header</strong> of the original request.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Original request is executed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>üü¢ OAuthClientInterceptor</code> can be added to <code>üü¢ RestTemplateBuilder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class RestTemplateBuilderConfig {

    @Value("${rest.template.baseUri}")
    String baseUri;

    // ...

    @Bean
    RestTemplateBuilder restTemplateBuilder(RestTemplateBuilderConfigurer configurer, OAuthClientInterceptor clientInterceptor) {
        assert StringUtils.hasText(baseUri);

        return configurer.configure(new RestTemplateBuilder())
                .additionalInterceptors(clientInterceptor) <i class="conum" data-value="1"></i><b>(1)</b>
                .uriTemplateHandler(new DefaultUriBuilderFactory(baseUri));
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>üü¢ OAuthClientInterceptor</code> handles <strong>client authorization</strong> in Authorization Server and <strong>enrichment</strong> of <code>Authorization</code> header for each request</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_testing_request_with_oauth_2_0"><a class="anchor" href="#_testing_request_with_oauth_2_0"></a>Testing request with OAuth 2.0</h3>
<div class="paragraph">
<p>If your test is annotated with <code>@SpringBootTest</code>, then you don&#8217;t need additional configuration.</p>
</div>
<div class="paragraph">
<p>If your test is annotated with <code>@RestClientTest</code>, then you need to <strong>mock</strong> <code>‚ö™ OAuth2AuthorizedClientManager</code> with <a href="https://docs.spring.io/spring-boot/api/java/org/springframework/boot/test/mock/mockito/MockBean.html" target="_blank" rel="noopener"><code>@MockBean</code></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MockBean
OAuth2AuthorizedClientManager authorizedClientManager;</code></pre>
</div>
</div>
<div class="paragraph">
<p>and add a <a href="https://docs.spring.io/spring-boot/api/java/org/springframework/boot/test/context/TestConfiguration.html" target="_blank" rel="noopener"><code>@TestConfiguration</code></a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@TestConfiguration
public static class TestConfig {

    @Bean <i class="conum" data-value="1"></i><b>(1)</b>
    ClientRegistrationRepository clientRegistrationRepository() {
        return new InMemoryClientRegistrationRepository(ClientRegistration.withRegistrationId("springauth")
                .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)
                .clientId("test")
                .tokenUri("test")
                .build());
    }

    @Bean <i class="conum" data-value="2"></i><b>(2)</b>
    OAuthClientInterceptor clientInterceptor(OAuth2AuthorizedClientManager authorizedClientManager,
            ClientRegistrationRepository clientRegistrationRepository) {
        return new OAuthClientInterceptor(authorizedClientManager, clientRegistrationRepository);
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Overrides default <code>‚ö™ ClientRegistrationRepository</code> and creates the one for the test.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Overrides default <code>üü¢ OAuthClientInterceptor</code> to use mocked <code>‚ö™ OAuth2AuthorizedClientManager</code> and customized <code>‚ö™ ClientRegistrationRepository</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, in <code>@BeforeEach</code> you can mock <code>‚ö™ OAuth2AuthorizedClientManager</code> behavior in following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BeforeEach
void setUp() throws JsonProcessingException {
    ClientRegistration clientRegistration = clientRegistrationRepository.findByRegistrationId("springauth");
    OAuth2AccessToken token = new OAuth2AccessToken(OAuth2AccessToken.TokenType.BEARER, "test", Instant.MIN, Instant.MAX); <i class="conum" data-value="1"></i><b>(1)</b>
    when(authorizedClientManager.authorize(any())).thenReturn(new OAuth2AuthorizedClient(clientRegistration, "test", token));
    // ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/core/OAuth2AccessToken.html" target="_blank" rel="noopener"><code>üü¢ OAuth2AccessToken</code></a> will be returned together with <code>üü¢ OAuth2AuthorizedClient</code> after invoking <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/oauth2/client/OAuth2AuthorizedClientManager.html#authorize(org.springframework.security.oauth2.client.OAuth2AuthorizeRequest)" target="_blank" rel="noopener"><code>OAuth2AuthorizedClientManager#authorize(OAuth2AuthorizeRequest authorizeRequest)</code></a></td>
</tr>
</table>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script src="../../../_/js/docsearch.js"></script>
  </body>
</html>
